---
- name: dependencies
  ansible.builtin.package:
    name:
      - make
      - build-essential
      - libssl-dev
      - zlib1g-dev
      - libbz2-dev
      - libreadline-dev
      - libsqlite3-dev
      - wget
      - curl
      - llvm
      - libncursesw5-dev
      - xz-utils
      - tk-dev
      - libxml2-dev
      - libxmlsec1-dev
      - libffi-dev
      - liblzma-dev

- name: check if pyenv is already installed
  ansible.builtin.stat:
    path: "{{ ansible_user_dir }}/.pyenv"
  register: pyenv_dir

- name: verify download destination exists
  ansible.builtin.file:
    path: "{{ ansible_user_dir }}/env_setup/pyenv"
    state: directory
  when: not pyenv_dir.stat.exists

- name: download install script
  ansible.builtin.get_url:
    url: http://pyenv.run
    dest: "{{ ansible_user_dir }}/env_setup/pyenv/install.sh"
    mode: "0700"
  when: not pyenv_dir.stat.exists

- name: run install script
  ansible.builtin.shell: "{{ ansible_user_dir }}/env_setup/pyenv/install.sh >> /dev/null"
  when: not pyenv_dir.stat.exists

- name: add vars to .bash_rc
  ansible.builtin.blockinfile:
    path: "$HOME/.bashrc"
    block: |
      export PATH="$HOME/.pyenv/bin:$PATH"
      eval "$(pyenv init --path)"
      eval "$(pyenv virtualenv-init -)"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - pyenv"
    insertbefore: BOF
    create: true
